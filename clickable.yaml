clickable_minimum_required: 8.0.0
builder: cmake
kill: qmlscene

# Setup Node.js in the build container
image_setup:
  run:
    - apt-get update
    - curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
    - apt-get install -y nodejs

libraries:
  bitwarden-cli:
    builder: custom
    src_dir: bitwarden-cli
    image_setup:
      run:
        - apt-get update
        - apt-get install -y curl
        - curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
        - apt-get install -y --no-install-recommends nodejs
    build: |
      cd ${SRC_DIR}
      echo "=== Debug: Architecture and Node.js info ==="
      uname -a
      node --version || echo "Node.js not found"
      npm --version || echo "npm not found"
      echo "=== Installing dependencies ==="
      npm install
      echo "=== Initializing submodules ==="
      npm run sub:init  
      echo "=== Building CLI ==="
      npm run build
      echo "=== Build completed, checking output ==="
      ls -la build/
      mkdir -p ${ROOT}/lib
      # Copy the built CLI to the lib directory
      cp -r build ${ROOT}/lib/bitwarden-cli-build
      # Create wrapper script that works for all architectures
      cat > ${ROOT}/lib/bw << 'EOF'
      #!/bin/bash
      set -e
      SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
      CLI_BUILD="$SCRIPT_DIR/bitwarden-cli-build"
      if ! command -v node >/dev/null 2>&1; then
        echo "Error: Node.js is required but not found in PATH."
        exit 1
      fi
      if [ ! -f "$CLI_BUILD/bw.js" ]; then
        echo "Error: Bitwarden CLI build not found at $CLI_BUILD/bw.js"
        exit 1
      fi
      exec node "$CLI_BUILD/bw.js" "$@"
      EOF
      chmod +x ${ROOT}/lib/bw
      echo "=== Build process completed ==="
