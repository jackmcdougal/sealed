name: Publish Sealed

on:
  push:
    branches:
      - master

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Pull Clickable Docker image
        run: |
          docker pull clickable/ci-20.04-arm64:latest

      - name: Initialize submodules
        run: |
          docker run --rm \
            --volume ./:/app \
            --workdir /app \
            clickable/ci-20.04-arm64:latest \
            bash -c "git config --global --add safe.directory /app && git config --global --add safe.directory /app/bitwarden-cli && git submodule update --init --recursive"

      - name: Build libraries
        run: |
          docker run --rm \
            --volume ./:/app \
            --workdir /app \
            clickable/ci-20.04-arm64:latest \
            bash -c "clickable build --libs --arch arm64"

      - name: Build application
        run: |
          docker run --rm \
            --volume ./:/app \
            --workdir /app \
            clickable/ci-20.04-arm64:latest \
            bash -c "clickable build --arch arm64"

      - name: Deploy to OpenStore
        run: |
          docker run --rm \
            --env OPENSTORE_API_KEY="${{ secrets.OPENSTORE_API_KEY }}" \
            --volume ./:/app \
            --workdir /app \
            clickable/ci-20.04-arm64:latest \
            bash -c "clickable publish --arch arm64 -- '${{ github.event.head_commit.message }}'"
